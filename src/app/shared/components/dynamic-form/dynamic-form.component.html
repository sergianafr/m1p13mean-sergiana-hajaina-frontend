@if (form()) {
  <form [formGroup]="form()!" (ngSubmit)="onSubmit()" class="dynamic-form">
    @for (field of config().fields; track field.key) {
      <div class="form-field" [class]="field.class ?? ''">
        @switch (field.type) {
          @case ('text') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <input
                matInput
                type="text"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
              />
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }

          @case ('email') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <input
                matInput
                type="email"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
              />
              <mat-icon matSuffix>email</mat-icon>
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }

          @case ('password') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <input
                matInput
                type="password"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
              />
              <mat-icon matSuffix>lock</mat-icon>
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }

          @case ('number') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <input
                matInput
                type="number"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
                [min]="field.min ?? null"
                [max]="field.max ?? null"
              />
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }

          @case ('textarea') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <textarea
                matInput
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
                [rows]="field.rows ?? 4"
              ></textarea>
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }

          @case ('select') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <mat-select [formControlName]="field.key">
                @for (option of field.options; track option.value) {
                  <mat-option [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                }
              </mat-select>
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }

          @case ('checkbox') {
            <div class="checkbox-field">
              <mat-checkbox [formControlName]="field.key">
                {{ field.label }}
              </mat-checkbox>
              @if (field.hint) {
                <mat-hint class="checkbox-hint">{{ field.hint }}</mat-hint>
              }
            </div>
          }

          @case ('radio') {
            <div class="radio-field">
              <label class="radio-label">{{ field.label }}</label>
              <mat-radio-group [formControlName]="field.key">
                @for (option of field.options; track option.value) {
                  <mat-radio-button [value]="option.value">
                    {{ option.label }}
                  </mat-radio-button>
                }
              </mat-radio-group>
              @if (field.hint) {
                <mat-hint class="radio-hint">{{ field.hint }}</mat-hint>
              }
            </div>
          }

          @case ('date') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ field.label }}</mat-label>
              <input
                matInput
                [matDatepicker]="picker"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
              />
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              @if (field.hint) {
                <mat-hint>{{ field.hint }}</mat-hint>
              }
              @if (hasError(field.key)) {
                <mat-error>{{ getErrorMessage(field) }}</mat-error>
              }
            </mat-form-field>
          }
        }
      </div>
    }

    <div class="form-actions">
      <button
        mat-stroked-button
        type="button"
        (click)="onCancel()"
        [disabled]="loading()"
      >
        {{ cancelLabel() }}
      </button>
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="loading() || !isFormValid()"
      >
        @if (loading()) {
          <mat-spinner diameter="20"></mat-spinner>
        } @else {
          {{ submitLabel() }}
        }
      </button>
    </div>
  </form>
}
